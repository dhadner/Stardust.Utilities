using System.ComponentModel;
using System.Globalization;
using FluentAssertions;
using Stardust.Utilities;
using Xunit;

namespace Stardust.Utilities.Tests;

/// <summary>
/// Unit tests for TypeConverters on all endian types.
/// Verifies PropertyGrid-style string-to-value and value-to-string conversion,
/// including decimal input, hex input with 0x prefix, and round-trip formatting.
/// </summary>
public class EndianTypeConverterTests
{
    // ???????????????????????????????????????????????????????????????????
    // UInt16Be
    // ???????????????????????????????????????????????????????????????????

    [Fact]
    public void UInt16Be_TypeConverterAttribute_IsWired()
    {
        var attr = TypeDescriptor.GetConverter(typeof(UInt16Be));
        attr.Should().BeOfType<UInt16BeTypeConverter>();
    }

    [Fact]
    public void UInt16Be_ConvertFrom_DecimalString()
    {
        var converter = new UInt16BeTypeConverter();
        var result = converter.ConvertFrom(null, null, "4660");
        result.Should().BeOfType<UInt16Be>();
        ((ushort)(UInt16Be)result!).Should().Be(0x1234);
    }

    [Fact]
    public void UInt16Be_ConvertFrom_HexString()
    {
        var converter = new UInt16BeTypeConverter();
        var result = converter.ConvertFrom(null, null, "0xABCD");
        ((ushort)(UInt16Be)result!).Should().Be(0xABCD);
    }

    [Fact]
    public void UInt16Be_ConvertTo_String()
    {
        var converter = new UInt16BeTypeConverter();
        UInt16Be value = 0x00FF;
        var result = converter.ConvertTo(null, null, value, typeof(string));
        result.Should().Be("00ff");
    }

    [Fact]
    public void UInt16Be_RoundTrip()
    {
        var converter = new UInt16BeTypeConverter();
        UInt16Be original = 0x1234;
        var str = (string)converter.ConvertTo(null, null, original, typeof(string))!;
        var restored = (UInt16Be)converter.ConvertFrom(null, null, "0x" + str)!;
        ((ushort)restored).Should().Be((ushort)original);
    }

    // ???????????????????????????????????????????????????????????????????
    // UInt32Be
    // ???????????????????????????????????????????????????????????????????

    [Fact]
    public void UInt32Be_TypeConverterAttribute_IsWired()
    {
        TypeDescriptor.GetConverter(typeof(UInt32Be)).Should().BeOfType<UInt32BeTypeConverter>();
    }

    [Fact]
    public void UInt32Be_ConvertFrom_DecimalString()
    {
        var converter = new UInt32BeTypeConverter();
        var result = converter.ConvertFrom(null, null, "305419896");
        ((uint)(UInt32Be)result!).Should().Be(0x12345678U);
    }

    [Fact]
    public void UInt32Be_ConvertFrom_HexString()
    {
        var converter = new UInt32BeTypeConverter();
        var result = converter.ConvertFrom(null, null, "0xDEADBEEF");
        ((uint)(UInt32Be)result!).Should().Be(0xDEADBEEFU);
    }

    [Fact]
    public void UInt32Be_ConvertTo_String()
    {
        var converter = new UInt32BeTypeConverter();
        UInt32Be value = 0x0000FFFF;
        var result = converter.ConvertTo(null, null, value, typeof(string));
        result.Should().Be("0000ffff");
    }

    [Fact]
    public void UInt32Be_RoundTrip()
    {
        var converter = new UInt32BeTypeConverter();
        UInt32Be original = 0xCAFEBABE;
        var str = (string)converter.ConvertTo(null, null, original, typeof(string))!;
        var restored = (UInt32Be)converter.ConvertFrom(null, null, "0x" + str)!;
        ((uint)restored).Should().Be((uint)original);
    }

    // ???????????????????????????????????????????????????????????????????
    // UInt64Be
    // ???????????????????????????????????????????????????????????????????

    [Fact]
    public void UInt64Be_TypeConverterAttribute_IsWired()
    {
        TypeDescriptor.GetConverter(typeof(UInt64Be)).Should().BeOfType<UInt64BeTypeConverter>();
    }

    [Fact]
    public void UInt64Be_ConvertFrom_HexString()
    {
        var converter = new UInt64BeTypeConverter();
        var result = converter.ConvertFrom(null, null, "0x0123456789ABCDEF");
        ((ulong)(UInt64Be)result!).Should().Be(0x0123456789ABCDEFUL);
    }

    [Fact]
    public void UInt64Be_ConvertTo_String()
    {
        var converter = new UInt64BeTypeConverter();
        UInt64Be value = 0x00000000DEADBEEF;
        var result = converter.ConvertTo(null, null, value, typeof(string));
        result.Should().Be("0x00000000deadbeef");
    }

    // ???????????????????????????????????????????????????????????????????
    // Int16Be
    // ???????????????????????????????????????????????????????????????????

    [Fact]
    public void Int16Be_TypeConverterAttribute_IsWired()
    {
        TypeDescriptor.GetConverter(typeof(Int16Be)).Should().BeOfType<Int16BeTypeConverter>();
    }

    [Fact]
    public void Int16Be_ConvertFrom_DecimalString()
    {
        var converter = new Int16BeTypeConverter();
        var result = converter.ConvertFrom(null, null, "256");
        ((short)(Int16Be)result!).Should().Be(256);
    }

    [Fact]
    public void Int16Be_ConvertFrom_HexString()
    {
        var converter = new Int16BeTypeConverter();
        var result = converter.ConvertFrom(null, null, "0x7FFF");
        ((short)(Int16Be)result!).Should().Be(short.MaxValue);
    }

    [Fact]
    public void Int16Be_ConvertTo_String()
    {
        var converter = new Int16BeTypeConverter();
        Int16Be value = 0x00FF;
        var result = converter.ConvertTo(null, null, value, typeof(string));
        result.Should().Be("00ff");
    }

    // ???????????????????????????????????????????????????????????????????
    // Int32Be
    // ???????????????????????????????????????????????????????????????????

    [Fact]
    public void Int32Be_TypeConverterAttribute_IsWired()
    {
        TypeDescriptor.GetConverter(typeof(Int32Be)).Should().BeOfType<Int32BeTypeConverter>();
    }

    [Fact]
    public void Int32Be_ConvertFrom_DecimalString()
    {
        var converter = new Int32BeTypeConverter();
        var result = converter.ConvertFrom(null, null, "12345");
        ((int)(Int32Be)result!).Should().Be(12345);
    }

    [Fact]
    public void Int32Be_ConvertFrom_HexString()
    {
        var converter = new Int32BeTypeConverter();
        var result = converter.ConvertFrom(null, null, "0x7FFFFFFF");
        ((int)(Int32Be)result!).Should().Be(int.MaxValue);
    }

    [Fact]
    public void Int32Be_ConvertTo_String()
    {
        var converter = new Int32BeTypeConverter();
        Int32Be value = 0x000000FF;
        var result = converter.ConvertTo(null, null, value, typeof(string));
        result.Should().Be("000000ff");
    }

    // ???????????????????????????????????????????????????????????????????
    // Int64Be
    // ???????????????????????????????????????????????????????????????????

    [Fact]
    public void Int64Be_TypeConverterAttribute_IsWired()
    {
        TypeDescriptor.GetConverter(typeof(Int64Be)).Should().BeOfType<Int64BeTypeConverter>();
    }

    [Fact]
    public void Int64Be_ConvertFrom_HexString()
    {
        var converter = new Int64BeTypeConverter();
        var result = converter.ConvertFrom(null, null, "0x7FFFFFFFFFFFFFFF");
        ((long)(Int64Be)result!).Should().Be(long.MaxValue);
    }

    [Fact]
    public void Int64Be_ConvertTo_String()
    {
        var converter = new Int64BeTypeConverter();
        Int64Be value = 1L;
        var result = converter.ConvertTo(null, null, value, typeof(string));
        result.Should().Be("0x0000000000000001");
    }

    // ???????????????????????????????????????????????????????????????????
    // UInt16Le
    // ???????????????????????????????????????????????????????????????????

    [Fact]
    public void UInt16Le_TypeConverterAttribute_IsWired()
    {
        TypeDescriptor.GetConverter(typeof(UInt16Le)).Should().BeOfType<UInt16LeTypeConverter>();
    }

    [Fact]
    public void UInt16Le_ConvertFrom_DecimalString()
    {
        var converter = new UInt16LeTypeConverter();
        var result = converter.ConvertFrom(null, null, "4660");
        ((ushort)(UInt16Le)result!).Should().Be(0x1234);
    }

    [Fact]
    public void UInt16Le_ConvertFrom_HexString()
    {
        var converter = new UInt16LeTypeConverter();
        var result = converter.ConvertFrom(null, null, "0xABCD");
        ((ushort)(UInt16Le)result!).Should().Be(0xABCD);
    }

    [Fact]
    public void UInt16Le_ConvertTo_String()
    {
        var converter = new UInt16LeTypeConverter();
        UInt16Le value = 0x00FF;
        var result = converter.ConvertTo(null, null, value, typeof(string));
        result.Should().Be("00ff");
    }

    [Fact]
    public void UInt16Le_RoundTrip()
    {
        var converter = new UInt16LeTypeConverter();
        UInt16Le original = 0x1234;
        var str = (string)converter.ConvertTo(null, null, original, typeof(string))!;
        var restored = (UInt16Le)converter.ConvertFrom(null, null, "0x" + str)!;
        ((ushort)restored).Should().Be((ushort)original);
    }

    // ???????????????????????????????????????????????????????????????????
    // UInt32Le
    // ???????????????????????????????????????????????????????????????????

    [Fact]
    public void UInt32Le_TypeConverterAttribute_IsWired()
    {
        TypeDescriptor.GetConverter(typeof(UInt32Le)).Should().BeOfType<UInt32LeTypeConverter>();
    }

    [Fact]
    public void UInt32Le_ConvertFrom_DecimalString()
    {
        var converter = new UInt32LeTypeConverter();
        var result = converter.ConvertFrom(null, null, "305419896");
        ((uint)(UInt32Le)result!).Should().Be(0x12345678U);
    }

    [Fact]
    public void UInt32Le_ConvertFrom_HexString()
    {
        var converter = new UInt32LeTypeConverter();
        var result = converter.ConvertFrom(null, null, "0xDEADBEEF");
        ((uint)(UInt32Le)result!).Should().Be(0xDEADBEEFU);
    }

    [Fact]
    public void UInt32Le_ConvertTo_String()
    {
        var converter = new UInt32LeTypeConverter();
        UInt32Le value = 0x0000FFFF;
        var result = converter.ConvertTo(null, null, value, typeof(string));
        result.Should().Be("0000ffff");
    }

    [Fact]
    public void UInt32Le_RoundTrip()
    {
        var converter = new UInt32LeTypeConverter();
        UInt32Le original = 0xCAFEBABE;
        var str = (string)converter.ConvertTo(null, null, original, typeof(string))!;
        var restored = (UInt32Le)converter.ConvertFrom(null, null, "0x" + str)!;
        ((uint)restored).Should().Be((uint)original);
    }

    // ???????????????????????????????????????????????????????????????????
    // UInt64Le
    // ???????????????????????????????????????????????????????????????????

    [Fact]
    public void UInt64Le_TypeConverterAttribute_IsWired()
    {
        TypeDescriptor.GetConverter(typeof(UInt64Le)).Should().BeOfType<UInt64LeTypeConverter>();
    }

    [Fact]
    public void UInt64Le_ConvertFrom_HexString()
    {
        var converter = new UInt64LeTypeConverter();
        var result = converter.ConvertFrom(null, null, "0x0123456789ABCDEF");
        ((ulong)(UInt64Le)result!).Should().Be(0x0123456789ABCDEFUL);
    }

    [Fact]
    public void UInt64Le_ConvertTo_String()
    {
        var converter = new UInt64LeTypeConverter();
        UInt64Le value = 0x00000000DEADBEEF;
        var result = converter.ConvertTo(null, null, value, typeof(string));
        result.Should().Be("00000000deadbeef");
    }

    // ???????????????????????????????????????????????????????????????????
    // Int16Le
    // ???????????????????????????????????????????????????????????????????

    [Fact]
    public void Int16Le_TypeConverterAttribute_IsWired()
    {
        TypeDescriptor.GetConverter(typeof(Int16Le)).Should().BeOfType<Int16LeTypeConverter>();
    }

    [Fact]
    public void Int16Le_ConvertFrom_DecimalString()
    {
        var converter = new Int16LeTypeConverter();
        var result = converter.ConvertFrom(null, null, "256");
        ((short)(Int16Le)result!).Should().Be(256);
    }

    [Fact]
    public void Int16Le_ConvertFrom_HexString()
    {
        var converter = new Int16LeTypeConverter();
        var result = converter.ConvertFrom(null, null, "0x7FFF");
        ((short)(Int16Le)result!).Should().Be(short.MaxValue);
    }

    [Fact]
    public void Int16Le_ConvertTo_String()
    {
        var converter = new Int16LeTypeConverter();
        Int16Le value = 0x00FF;
        var result = converter.ConvertTo(null, null, value, typeof(string));
        result.Should().Be("00ff");
    }

    // ???????????????????????????????????????????????????????????????????
    // Int32Le
    // ???????????????????????????????????????????????????????????????????

    [Fact]
    public void Int32Le_TypeConverterAttribute_IsWired()
    {
        TypeDescriptor.GetConverter(typeof(Int32Le)).Should().BeOfType<Int32LeTypeConverter>();
    }

    [Fact]
    public void Int32Le_ConvertFrom_DecimalString()
    {
        var converter = new Int32LeTypeConverter();
        var result = converter.ConvertFrom(null, null, "12345");
        ((int)(Int32Le)result!).Should().Be(12345);
    }

    [Fact]
    public void Int32Le_ConvertFrom_HexString()
    {
        var converter = new Int32LeTypeConverter();
        var result = converter.ConvertFrom(null, null, "0x7FFFFFFF");
        ((int)(Int32Le)result!).Should().Be(int.MaxValue);
    }

    [Fact]
    public void Int32Le_ConvertTo_String()
    {
        var converter = new Int32LeTypeConverter();
        Int32Le value = 0x000000FF;
        var result = converter.ConvertTo(null, null, value, typeof(string));
        result.Should().Be("000000ff");
    }

    // ???????????????????????????????????????????????????????????????????
    // Int64Le
    // ???????????????????????????????????????????????????????????????????

    [Fact]
    public void Int64Le_TypeConverterAttribute_IsWired()
    {
        TypeDescriptor.GetConverter(typeof(Int64Le)).Should().BeOfType<Int64LeTypeConverter>();
    }

    [Fact]
    public void Int64Le_ConvertFrom_HexString()
    {
        var converter = new Int64LeTypeConverter();
        var result = converter.ConvertFrom(null, null, "0x7FFFFFFFFFFFFFFF");
        ((long)(Int64Le)result!).Should().Be(long.MaxValue);
    }

    [Fact]
    public void Int64Le_ConvertTo_String()
    {
        var converter = new Int64LeTypeConverter();
        Int64Le value = 1L;
        var result = converter.ConvertTo(null, null, value, typeof(string));
        result.Should().Be("0000000000000001");
    }

    // ???????????????????????????????????????????????????????????????????
    // CanConvertFrom
    // ???????????????????????????????????????????????????????????????????

    [Theory]
    [InlineData(typeof(UInt16BeTypeConverter))]
    [InlineData(typeof(UInt32BeTypeConverter))]
    [InlineData(typeof(UInt64BeTypeConverter))]
    [InlineData(typeof(Int16BeTypeConverter))]
    [InlineData(typeof(Int32BeTypeConverter))]
    [InlineData(typeof(Int64BeTypeConverter))]
    [InlineData(typeof(UInt16LeTypeConverter))]
    [InlineData(typeof(UInt32LeTypeConverter))]
    [InlineData(typeof(UInt64LeTypeConverter))]
    [InlineData(typeof(Int16LeTypeConverter))]
    [InlineData(typeof(Int32LeTypeConverter))]
    [InlineData(typeof(Int64LeTypeConverter))]
    public void AllConverters_CanConvertFrom_String(Type converterType)
    {
        var converter = (TypeConverter)Activator.CreateInstance(converterType)!;
        converter.CanConvertFrom(null, typeof(string)).Should().BeTrue();
    }

    [Theory]
    [InlineData(typeof(UInt16BeTypeConverter))]
    [InlineData(typeof(UInt32BeTypeConverter))]
    [InlineData(typeof(UInt64BeTypeConverter))]
    [InlineData(typeof(Int16BeTypeConverter))]
    [InlineData(typeof(Int32BeTypeConverter))]
    [InlineData(typeof(Int64BeTypeConverter))]
    [InlineData(typeof(UInt16LeTypeConverter))]
    [InlineData(typeof(UInt32LeTypeConverter))]
    [InlineData(typeof(UInt64LeTypeConverter))]
    [InlineData(typeof(Int16LeTypeConverter))]
    [InlineData(typeof(Int32LeTypeConverter))]
    [InlineData(typeof(Int64LeTypeConverter))]
    public void AllConverters_CannotConvertFrom_Int(Type converterType)
    {
        var converter = (TypeConverter)Activator.CreateInstance(converterType)!;
        converter.CanConvertFrom(null, typeof(int)).Should().BeFalse();
    }

    // ???????????????????????????????????????????????????????????????????
    // ConvertTo null value
    // ???????????????????????????????????????????????????????????????????

    [Fact]
    public void UInt32Be_ConvertTo_NullValue_ReturnsNull()
    {
        var converter = new UInt32BeTypeConverter();
        var result = converter.ConvertTo(null, null, null, typeof(string));
        result.Should().BeNull();
    }

    [Fact]
    public void UInt32Le_ConvertTo_NullValue_ReturnsNull()
    {
        var converter = new UInt32LeTypeConverter();
        var result = converter.ConvertTo(null, null, null, typeof(string));
        result.Should().BeNull();
    }

    // ???????????????????????????????????????????????????????????????????
    // Hex prefix case insensitivity
    // ???????????????????????????????????????????????????????????????????

    [Fact]
    public void UInt32Be_ConvertFrom_HexPrefix_Lowercase()
    {
        var converter = new UInt32BeTypeConverter();
        var result = converter.ConvertFrom(null, null, "0xff");
        ((uint)(UInt32Be)result!).Should().Be(0xFF);
    }

    [Fact]
    public void UInt32Be_ConvertFrom_HexPrefix_Uppercase()
    {
        var converter = new UInt32BeTypeConverter();
        var result = converter.ConvertFrom(null, null, "0XFF");
        ((uint)(UInt32Be)result!).Should().Be(0xFF);
    }

    [Fact]
    public void UInt32Le_ConvertFrom_HexPrefix_Lowercase()
    {
        var converter = new UInt32LeTypeConverter();
        var result = converter.ConvertFrom(null, null, "0xff");
        ((uint)(UInt32Le)result!).Should().Be(0xFF);
    }

    [Fact]
    public void UInt32Le_ConvertFrom_HexPrefix_Uppercase()
    {
        var converter = new UInt32LeTypeConverter();
        var result = converter.ConvertFrom(null, null, "0XFF");
        ((uint)(UInt32Le)result!).Should().Be(0xFF);
    }
}
